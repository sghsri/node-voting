<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css">
    <title>Document</title>
</head>
<script src="/socket.io/socket.io.js"></script>

<body>
    <div class="box">
        <h1 id='question' class="title is-1">Question</h1>
        <h2 id='id' class='title' style='font-weight:normal'></h2>
        <button id='delete' class='button is-danger' onclick="deletePoll()"> Delete Poll </button>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    </div>
    <script>
        var id = new URL(window.location.href).pathname.split('/')[2];
        getCourse();
        var socket = io.connect('https://aqueous-caverns-48025.herokuapp.com');
        socket.on('connect', function (data) {
            socket.emit('join', `${id}`);
        });
        socket.on('updatePoll', function (data) {
            refresh(data);
        });

        function refresh(question) {
            $('#id').text(`id: ${id}`);
            $("#question").text(question.vote.question);
            let arr = question.vote.answers;
            $("p").remove();
            for (var i = 0; i < arr.length; i++) {
                $("#delete").before(
                    `<p class='subtitle is-5' style='margin-top:5px;'> ${arr[i].answertext}, votes: ${arr[i].votes}</p>`
                );
            }
        }

        function getCourse() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var question = JSON.parse(this.responseText);
                    console.log(question);
                    refresh(question);
                } else if (this.readyState == 4 && this.status == 404) {
                    alert("There was an error");
                }
            };
            xhttp.open("GET", `/api/party/${id}`, true);
            xhttp.send();
        }

        function deletePoll() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    window.location.href = `/`;
                } else if (this.readyState == 4 && this.status == 404) {
                    alert("There was an error");
                }
            };
            xhttp.open("DELETE", `/api/party/${id}`, true);
            xhttp.send();
        }
    </script>
</body>

</html>